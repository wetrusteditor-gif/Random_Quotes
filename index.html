<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Get A Quote</title>
<style>
  :root{
    --bg1:#667eea; --bg2:#764ba2;
    --text:#333; --muted:#666; --muted-2:#999; --white:#fff;
    --radius:20px; --pad:40px;
  }
  * { box-sizing:border-box; }
  html,body { height:100%; }
  body {
    margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:var(--text);
    background:linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%);
    display:flex; align-items:center; justify-content:center; padding:20px;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; -webkit-tap-highlight-color:transparent;
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0));
  }
  .container {
    background:var(--white); border-radius:var(--radius); padding:var(--pad);
    box-shadow:0 20px 60px rgba(0,0,0,.3); width:100%; max-width:900px;
  }
  h1 { text-align:center; margin:0 0 10px; color:var(--text);
    font-size: clamp(1.625rem, 2.5vw + 1rem, 2.5rem); line-height:1.15; }
  .quote-count { text-align:center; color:var(--muted); margin-bottom:20px;
    font-size: clamp(0.95rem, 0.5vw + 0.8rem, 1.1rem); font-weight:500; }

  /* Viewer height is set dynamically based on image aspect ratio */
  .image-wrapper {
    position:relative; width:100%; height:auto; background:#f5f5f5;
    border-radius:15px; margin-bottom: clamp(18px, 2.5vw, 25px);
    display:flex; justify-content:center; align-items:center; overflow:hidden;
    transition: height .28s ease;
  }
  .quote-image {
    width:100%; height:100%; max-width:100%; object-fit:contain; border-radius:15px;
    display:none; animation:fadeIn .35s ease-in;
  }
  .quote-image.active { display:block; }
  @keyframes fadeIn { from{opacity:0; transform:scale(.98);} to{opacity:1; transform:scale(1);} }
  @media (prefers-reduced-motion: reduce){ .quote-image { animation:none !important; } }

  .placeholder { color:var(--muted-2); font-size: clamp(1rem, 1vw + 0.9rem, 1.3rem);
    text-align:center; padding: clamp(24px, 3vw, 40px); width:100%; }
  .placeholder.hidden { display:none; }

  .btn-row { display:flex; justify-content:center; }
  button {
    background:linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%);
    color:#fff; border:none; padding:14px 34px;
    font-size: clamp(1rem, 0.6vw + 0.9rem, 1.15rem);
    border-radius:999px; cursor:pointer; transition:transform .2s, box-shadow .2s;
    font-weight:600; min-height:48px;
  }
  button:hover { transform:translateY(-2px); box-shadow:0 10px 25px rgba(102,126,234,.4); }

  .loading-overlay { position:absolute; inset:0; background:rgba(0,0,0,.5);
    display:flex; justify-content:center; align-items:center; border-radius:15px; z-index:2; }
  .loading-overlay.hidden { display:none; }
  .spinner { width:44px; height:44px; border:5px solid rgba(255,255,255,.3);
    border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite; }
  @keyframes spin { to{ transform:rotate(360deg); } }

  .copyright { text-align:center; color:var(--muted); font-size:.9rem;
    padding-top:18px; border-top:1px solid #e0e0e0; margin-top:20px; }

  @media (max-width: 768px){
    :root{ --pad:24px; --radius:16px; }
    body { padding:16px; }
    .container { padding:var(--pad); border-radius:var(--radius); }
    .image-wrapper, .quote-image { border-radius:14px; }
  }
  @media (max-width: 480px){
    body { padding:12px; }
    .container { padding:18px; }
    .btn-row { display:block; }
    button { width:100%; }
  }
  @media (max-width: 360px){
    .container { padding:14px; }
    .spinner { width:38px; height:38px; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>âœ¨ Get A Quote</h1>
    <p class="quote-count">Total Quotes: <strong id="totalCount">0</strong></p>

    <div class="image-wrapper" id="viewer">
      <div class="loading-overlay hidden" id="loadingOverlay"><div class="spinner"></div></div>
      <div class="placeholder" id="placeholder">Tap the button to see an inspiring quote! ðŸŽ¯</div>
      <img class="quote-image" id="quoteImage" alt="Quote">
    </div>

    <div class="btn-row">
      <button id="quoteBtn">Get A Quote</button>
    </div>

    <div class="copyright">Â© Wisdom And Enlightenment Trust</div>
  </div>

<script>
  // === CONFIG ===
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzYKfmVEMzFD5LDm0izPYcoI5mXyzKejVX6OCpuSOkPHTaPaL7vMl4E9yYhKU3Qp4j3PQ/exec";

  // Bump the cache key to avoid stale shapes
  const CACHE_KEY = "quotes_from_drive_folder_v2";
  const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6 hours

  // Elements
  const viewer = document.getElementById('viewer');
  const placeholder = document.getElementById('placeholder');
  const quoteImage = document.getElementById('quoteImage');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const totalCountEl = document.getElementById('totalCount');
  const quoteBtn = document.getElementById('quoteBtn');

  let ITEMS = [];          // [{id, url}]
  let currentIndex = -1;
  let lastNatural = { w: 0, h: 0 };

  const showLoading = (on) => loadingOverlay.classList.toggle('hidden', !on);

  // --- helpers ---
  function saveCache(items) {
    try { localStorage.setItem(CACHE_KEY, JSON.stringify({ at: Date.now(), data: items })); } catch {}
  }
  function loadCache() {
    try {
      const d = JSON.parse(localStorage.getItem(CACHE_KEY));
      if (!d || !Array.isArray(d.data)) return null;
      if (Date.now() - d.at > CACHE_TTL_MS) return null;
      return d.data;
    } catch { return null; }
  }

  function normalizeItems(arr) {
    if (!Array.isArray(arr)) return [];
    return arr.map(x => {
      if (typeof x === 'string') {
        // If API ever returns strings, try to extract id from ...id=XYZ
        const m = x.match(/[?&]id=([^&]+)/);
        return { id: m ? decodeURIComponent(m[1]) : '', url: x };
      } else if (x && (x.id || x.url)) {
        return { id: x.id || '', url: x.url || '' };
      }
      return null;
    }).filter(v => v && v.url);
  }

  async function fetchItems() {
    const cached = loadCache();
    if (cached) return cached;

    const res = await fetch(APPS_SCRIPT_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Apps Script fetch failed: ' + res.status);
    const json = await res.json();
    const items = normalizeItems(json);
    if (items.length) saveCache(items);
    return items;
  }

  // Try multiple URL patterns for a file until one loads
  function candidateUrlsFor(item) {
    const id = item.id || (item.url.match(/[?&]id=([^&]+)/)?.[1] || '').trim();
    const urls = [];
    if (item.url) urls.push(item.url); // given (uc?export=view)
    if (id) {
      urls.push(`https://lh3.googleusercontent.com/d/${id}`);                 // very reliable for public images
      urls.push(`https://drive.google.com/thumbnail?sz=w2000&id=${id}`);     // large thumbnail stream
      urls.push(`https://drive.google.com/uc?export=download&id=${id}`);     // download endpoint (often works inline)
    }
    // de-dup
    return Array.from(new Set(urls));
  }

  function loadWithFallback(item, onSuccess, onFail) {
    const urls = candidateUrlsFor(item);
    let k = 0;

    const tryNext = () => {
      if (k >= urls.length) {
        onFail?.();
        return;
      }
      const src = urls[k++];
      const probe = new Image();
      probe.onload = () => onSuccess(src, probe.naturalWidth || probe.width, probe.naturalHeight || probe.height);
      probe.onerror = tryNext;
      probe.src = src;
    };
    tryNext();
  }

  // viewer sizing
  function resizeViewerToImage() {
    if (!lastNatural.w || !lastNatural.h) return;
    const ratio = lastNatural.h / lastNatural.w;
    const w = viewer.clientWidth || viewer.offsetWidth || 0;
    const maxH = Math.max(240, window.innerHeight - 160);
    const targetH = Math.min(w * ratio, maxH);
    viewer.style.height = `${Math.round(targetH)}px`;
  }

  function showImage(src, naturalW, naturalH, altText) {
    lastNatural = { w: naturalW, h: naturalH };
    resizeViewerToImage();
    quoteImage.src = src;
    quoteImage.alt = altText || "Quote";
    quoteImage.classList.add('active');
  }

  function getRandomQuote() {
    if (!ITEMS.length) return;

    let i, guard = 0;
    do {
      i = Math.floor(Math.random() * ITEMS.length);
      guard++;
      if (guard > 20) break;
    } while (i === currentIndex && ITEMS.length > 1);
    currentIndex = i;

    const item = ITEMS[i];

    placeholder.classList.add('hidden');
    quoteImage.classList.remove('active');
    showLoading(true);

    loadWithFallback(item,
      (src, w, h) => {
        showLoading(false);
        showImage(src, w, h, `Quote ${i+1}`);
      },
      () => {
        showLoading(false);
        placeholder.textContent = "Could not load this image (403/404). It might be private or removed.";
        placeholder.classList.remove('hidden');
        // remove the broken one so the next click works
        ITEMS.splice(i, 1);
        totalCountEl.textContent = ITEMS.length;
      }
    );
  }

  async function init() {
    showLoading(true);
    try {
      ITEMS = await fetchItems();
      totalCountEl.textContent = ITEMS.length;
      quoteBtn.disabled = !ITEMS.length;

      if (ITEMS.length) {
        // initial placeholder height
        viewer.style.height = '48vh';
        console.log('First item:', ITEMS[0]);
      } else {
        viewer.style.height = '260px';
        placeholder.textContent = 'No images found. Check web app & folder sharing.';
        placeholder.classList.remove('hidden');
      }
    } catch (e) {
      console.error(e);
      placeholder.textContent = 'Could not load image list. Check web app access & folder sharing.';
      placeholder.classList.remove('hidden');
    } finally {
      showLoading(false);
    }
  }

  window.addEventListener('resize', resizeViewerToImage);
  window.addEventListener('orientationchange', () => setTimeout(resizeViewerToImage, 120));
  window.addEventListener('load', () => {
    quoteBtn.addEventListener('click', getRandomQuote);
    init();
  });
</script>
</body>
</html>
